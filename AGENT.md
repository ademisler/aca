# AGENT.md - ACA - AI Content Agent (Definitive Developer's Guide)

**Version: 1.1**
**Last Updated:** 2025-07-25

This document provides a definitive, highly-detailed technical overview of the "ACA - AI Content Agent" WordPress plugin. It is structured to guide developers and AI tools from high-level concepts down to specific implementation details, workflows, and known issues.

## 1. Core Concepts (The Plugin's Domain)

To understand the code, one must first understand the core concepts of the plugin:

-   **Style Guide**: A text-based description of a website's writing style (tone, voice, sentence structure). It is generated by the **Engine** by analyzing existing posts and is used as a system-level instruction for the Gemini API to ensure brand consistency.
-   **Idea**: A potential article title. Ideas are generated by the **Engine** based on existing content or Google Search Console queries. They are stored in a custom database table and have a status (`pending`, `drafted`, `rejected`).
-   **Draft**: A full WordPress post with a `draft` status. It is created by the **Engine** from an **Idea** and is the primary output of the plugin.
-   **Enrichment**: The process of adding value to a newly created **Draft**. This includes adding internal links, a featured image, tags, and a meta description. This is handled by the **Engine** after the initial draft is created.
-   **Automation Level**: The user-configured mode of operation (`manual`, `semi-auto`, `full-auto`) that dictates how the **Cron Controller** triggers the **Engine** to create Ideas and Drafts.

## 2. System Architecture: A Layered Model

The plugin uses a standard, layered architecture to separate concerns:

-   **1. Presentation Layer (UI)**: Renders the admin interface. This is the primary role of `class-aca-dashboard.php` and the `render_*` methods in `class-aca-admin.php`, supported by the assets in `/admin`.
-   **2. Controller/Dispatcher Layer (AJAX/Cron)**: The entry point for all dynamic requests. It validates requests and delegates them to the business logic layer. This is the role of `handle_ajax_*` methods in `class-aca-admin.php` and the `run_*` methods in `class-aca-cron.php`.
-   **3. Business Logic Layer (Engine)**: The plugin's core. `includes/class-aca.php` (`ACA_AI_Content_Agent_Engine`) contains all the complex logic for content analysis, prompt engineering, and post creation.
-   **4. Service/Gateway Layer**: Manages all external API communications. `includes/api.php` (for Gemini) and `includes/licensing.php` (for Gumroad) abstract these external calls.
-   **5. Data Access Layer**: Handles all database interactions. This is not a formal class but a collection of direct `$wpdb` calls and WordPress Options API functions (`get_option`, `update_option`, `set_transient`) spread throughout the Engine and Controller layers.

## 3. File-by-File Functional Breakdown

-   **`aca.php`**: The main plugin bootstrap file; loads all dependencies, initializes classes, and handles activation/deactivation hooks.
-   **`uninstall.php`**: Contains the code to completely remove all plugin data (tables, options, roles) upon uninstallation.
-   **`readme.txt`**: The user-facing plugin description for the WordPress Plugin Directory.
-   **`composer.json` / `composer.lock`**: Defines and locks the PHP dependency on `woocommerce/action-scheduler`.
-   **`.gitignore`**: Specifies files and directories for Git to ignore.
-   **`AGENT.md`**: This file.
-   **`/admin/css/aca-admin.css`**: Contains all custom CSS for styling the plugin's admin pages.
-   **`/admin/js/aca-admin.js`**: Contains all client-side JavaScript for handling user interactions and making AJAX requests.
-   **`/includes/api.php`**: A dedicated gateway that handles all API communication with Google Gemini, including request/response logic and key encryption/decryption.
-   **`/includes/class-aca-admin.php`**: The primary controller for the admin panel; registers settings, creates menu pages, and handles all incoming AJAX requests.
-   **`/includes/class-aca-cron.php`**: Manages all scheduled tasks (cron jobs) using the Action Scheduler library.
-   **`/includes/class-aca-dashboard.php`**: Responsible for rendering the main dashboard UI.
-   **`/includes/class-aca-onboarding.php`**: Manages the one-time setup wizard for new users.
-   **`/includes/class-aca-privacy.php`**: Integrates with the WordPress privacy tools for exporting and erasing user data.
-   **`/includes/class-aca.php`**: The core **Engine** of the plugin, containing all the business logic.
-   **`/includes/licensing.php`**: Handles all logic related to validating the Pro version license key via the Gumroad API.
-   **`/languages/aca.pot`**: The main translation template file.
-   **`index.php` (in all subdirectories)**: Standard WordPress security files to prevent directory listing.

## 4. Dynamic Workflows & Data Flow

### 4.1. User-Triggered: Idea to Draft
This is the primary user-facing workflow.

```
[User clicks "Write Draft" in UI]
       |
       v
[admin/js/aca-admin.js] --(AJAX Request: action='aca_ai_content_agent_write_draft', id=123)--> [WordPress Core]
       |
       v
[class-aca-admin.php::handle_ajax_write_draft()]
       | 1. Verifies nonce & capabilities.
       | 2. Calls Engine with sanitized idea ID.
       v
[class-aca.php::write_post_draft(123)]
       | 1. Reads idea from database.
       | 2. Fetches style guide from options.
       | 3. Calls API Gateway with a constructed prompt.
       v
[api.php::aca_ai_content_agent_call_gemini_api(prompt)]
       | 1. Decrypts API key.
       | 2. Makes external call via `wp_remote_post()`.
       | 3. Returns API response (JSON string) or WP_Error.
       v
[Back in class-aca.php::write_post_draft()]
       | 1. Parses JSON response.
       | 2. Creates post via `wp_insert_post()`.
       | 3. Calls `enrich_draft()` to add links, images, etc.
       | 4. Updates idea status in the database.
       | 5. Returns success array {message, edit_link}.
       v
[Back in class-aca-admin.php::handle_ajax_write_draft()]
       |
       v
[Sends JSON success response back to browser]
```

### 4.2. Automated: Scheduled Idea Generation
This workflow runs in the background for semi-automatic and fully-automatic modes.

1.  **Scheduling**: `class-aca-cron.php::schedule_events()` registers a recurring action `aca_ai_content_agent_run_main_automation` with Action Scheduler.
2.  **Execution**: Action Scheduler triggers the hook at the scheduled time.
3.  **Callback**: `class-aca-cron.php::run_main_automation()` is executed.
4.  **Logic**: It checks the `working_mode` option. If not `manual`, it calls `ACA_AI_Content_Agent_Engine::generate_ideas()`.
5.  **Engine**: The engine gets existing post titles, builds a prompt, calls the Gemini API via the gateway, parses the response, and inserts the new ideas into the `..._ideas` table with a `pending` status.

## 5. Critical Code Analysis & Known Issues

-   **Database Column Mismatch (CRITICAL BUG)**:
    -   **Location**: `includes/class-aca.php` in methods `add_log`, `generate_ideas`, `generate_content_cluster`.
    -   **Issue**: The `$wpdb->insert` calls use incorrect, non-existent keys in their data arrays (e.g., `idea_title` instead of `title`, `created_at` instead of `generated_date`).
    -   **Impact**: The code only functions due to a loose MySQL mode that maps values sequentially. This is extremely brittle and will break if the database schema or column order changes. **This is the highest priority bug to fix.**

-   **Non-Existent Capability Check (BUG)**:
    -   **Location**: `includes/class-aca-admin.php` in method `add_update_link`.
    -   **Issue**: The code checks for `current_user_can('manage_aca_settings')`. However, the plugin registers the capability `manage_aca_ai_content_agent_settings` in `aca.php`. 
    -   **Impact**: The capability check will always fail, meaning the "Get Update Suggestion with ACA" link will never appear on the post list for any user. The correct capability must be used.

-   **Uncached Admin Queries (Performance Concern)**:
    -   **Location**: `includes/class-aca-admin.php` in method `display_admin_notices`.
    -   **Issue**: This method runs three separate database queries (`get_option`, `$wpdb->get_var`, `$wpdb->get_row`) on **every single admin page load** to generate potential notices. These queries are not cached.
    -   **Impact**: On sites with very large `..._ideas` or `..._logs` tables, this can add unnecessary database load and slow down the entire WordPress admin experience. These queries should be cached using transients, similar to how the dashboard widgets are.

-   **Inefficient Internal Linking (Performance & Quality Concern)**:
    -   **Location**: `includes/class-aca.php` in method `add_internal_links`.
    -   **Issue**: The function queries the entire `wp_posts` table using multiple `LIKE` conditions, which is one of the most inefficient query types in SQL, especially on large tables. The keyword extraction is also very basic.
    -   **Impact**: This can cause significant performance degradation when creating a draft on a site with a large amount of content. The quality of the links may also be poor as it just links the first keyword occurrence it finds.

-   **Lack of Transactional Integrity (Robustness Concern)**:
    -   **Location**: `includes/class-aca.php` in method `write_post_draft`.
    -   **Issue**: The method performs several distinct operations: API call, `wp_insert_post`, `wpdb->update` on the idea status. If a later step fails (e.g., the final `wpdb->update`), the system is left in an inconsistent state (e.g., a draft exists but the idea is still marked as `pending`).
    -   **Impact**: This can lead to duplicate drafts being created from a single idea and a confusing user experience.

-   **Broad Author Capability Grant (Design Concern)**:
    -   **Location**: `aca.php` in method `ACA_Bootstrap::add_custom_capabilities`.
    -   **Issue**: The `author` role is granted the `view_aca_ai_content_agent_dashboard` capability.
    -   **Impact**: This means regular authors can see the ideas and activities of all other users, including administrators, which may not be desirable from a privacy or workflow perspective.

## 6. How to Extend the Plugin

### Adding a New Setting
1.  **Add the Field**: In `class-aca-admin.php::register_settings()`, add a new `add_settings_field()` call and a corresponding `render_*_field()` method to display the HTML.
2.  **Sanitize the Input**: In `class-aca-admin.php::sanitize_options()`, add the new setting's key to the ` from the `$input` array and applying the correct sanitization function (e.g., `sanitize_text_field`, `absint`).
3.  **Use the Setting**: Access the new setting from the global options array: `$options = get_option('aca_ai_content_agent_options'); $my_setting = $options['new_setting_key'];`

### Adding a New Enrichment Step
1.  **Create the Method**: In `class-aca.php`, create a new public or private static method, e.g., `add_author_bio($post_id)`.
2.  **Hook into Enrichment**: In `class-aca.php::enrich_draft()`, add a call to your new method: `self::add_author_bio($post_id)`.

## 7. Proposed New Directory Structure

This structure will make the codebase much easier to navigate, maintain, and test.

```
/includes/
├── admin/
│   ├── class-aca-admin-menu.php
│   ├── class-aca-admin-settings.php
│   ├── class-aca-ajax-handler.php
│   ├── class-aca-admin-views.php
│   ├── class-aca-admin-notices.php
│   └── class-aca-onboarding.php
├── services/
│   ├── class-aca-content-generator-service.php
│   ├── class-aca-content-enrichment-service.php
│   ├── class-aca-style-guide-service.php
│   └── class-aca-licensing-service.php
├── clients/
│   ├── class-aca-gemini-client.php
│   ├── class-aca-gsc-client.php
│   ├── class-aca-pexels-client.php
│   ├── class-aca-openai-client.php
│   └── class-aca-copyscape-client.php
├── integrations/
│   ├── class-aca-post-integration.php
│   └── class-aca-privacy.php
├── utils/
│   ├── class-aca-crypto-util.php
│   └── class-aca-plugin-helper.php
├── class-aca-lifecycle.php
├── class-aca-cron.php
└── class-aca-main.php (The main plugin controller)
```